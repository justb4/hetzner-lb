# Inspired from https://github.com/5car1z/ansible-debian-provisioning
- name: "Ubuntu Server Setup"
  hosts: all
  become_user: root
  gather_facts: yes

  vars_files:
    - vars/vars.yml

  roles:
    # https://github.com/justb4/ansible-users-and-groups
    - name: justb4.users-and-groups
      tags: users

    - name: justb4.ubuntu-base
      tags: ubuntu-base

    # https://github.com/geerlingguy/ansible-role-docker
    # defaults: https://github.com/geerlingguy/ansible-role-docker/blob/master/defaults/main.yml
    - name: geerlingguy.docker
      tags: docker
      docker_users:
        - "{{ my_admin_user }}"

  tasks:

    - name: Set authorized key for GH Action user admin
      ansible.posix.authorized_key:
        user: "{{ my_admin_user }}"
        key: "{{ lookup('file', 'vars/sshkey.rsa.pub') }}"
        state: present

    - name: Set authorized key for GH Action user root
      ansible.posix.authorized_key:
        user: "root"
        key: "{{ lookup('file', 'vars/sshkey.rsa.pub') }}"
        state: present

    - name: "Set global env vars"
      lineinfile:
        dest: /etc/environment
        state: present
        regexp: '^EMAIL'
        line: 'EMAIL={{ my_email }}'

    - name: "Populate /etc/environment"
      become: true
      lineinfile:
        dest: "/etc/environment"
        state: present
        regexp: "^{{ item.key }}="
        line: "{{ item.key }}={{ item.value}}"
      with_dict: "{{ etc_environment }}"
